
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>R√©seau Secret</title>
  <style>
/* Style hacker underground */
body {
  background-color: black;
  color: #00ff00;
  font-family: 'Courier New', monospace;
  text-align: center;
  padding-top: 5vh;
}

/* Conteneur avec un effet cyber */
.container {
  max-width: 600px;
  margin: auto;
  padding: 20px;
  border: 2px solid #00ff00;
  background: rgba(0, 0, 0, 0.9);
  border-radius: 10px;
  box-shadow: 0px 0px 15px #00ff00;
}

/* Boutons style terminal */
button {
  background: rgba(0, 255, 0, 0.7);
  color: black;
  border: 2px solid #00ff00;
  padding: 12px;
  font-family: inherit;
  cursor: pointer;
  margin-top: 10px;
  border-radius: 5px;
  width: 85%;
  text-transform: uppercase;
  box-shadow: 0px 0px 8px #00ff00;
}
button:hover {
  background: rgba(255, 0, 0, 0.8);
  box-shadow: 0px 0px 12px red;
}

/* Panneau admin avec un effet sinistre */
#adminPanel {
  border: 2px solid #00ff00;
  padding: 10px;
  margin-top: 20px;
  border-radius: 10px;
  background: rgb(0, 0, 0);
  box-shadow: 0px 0px 12px #00ff00;
}

/* Messages du chat format√©s avec effet terminal */
.message {
  padding: 5px;
  margin-bottom: 5px;
  border-radius: 5px;
  font-size: 14px;
  font-weight: bold;
}
.admin-message {
  background-color: rgba(255, 0, 0, 0.2);
  border-left: 5px solid red;
  text-shadow: 0px 0px 8px red;
}
.user-message {
  background-color: rgba(0, 255, 0, 0.2);
  border-left: 5px solid #00ff00;
  text-shadow: 0px 0px 8px #00ff00;
}

/* Effet n√©on sur les titres */
h1, h2, h3 {
  text-shadow: 0px 0px 10px #00ff00;
}

/* Effet de scan num√©rique sur l'input */
input {
  background: black;
  color: #00ff00;
  border: 1px solid #00ff00;
  padding: 8px;
  font-family: 'Courier New', monospace;
  box-shadow: 0px 0px 8px #00ff00;
}
 /* Ces √©l√©ments sont masqu√©s initialement */
    #auth, #adminPanel, #chat, #imageUpload, #fileUpload {
      display: none;
    }
  </style>
</head>
<body>
    <div id="userProfile" style="display: none; text-align: center;">
        <h2>Bienvenue, <span id="userName"></span> !</h2>
        <p><strong>Statut :</strong> <span id="userStatus"></span></p>
    </div>
    <div class="container">
        <h1>Acc√®s Restreint</h1>
        <p>Entrez le mot de passe g√©n√©ral :</p>
        <input type="password" id="passwordInput">
    <button onclick="checkGeneralPassword()">Valider</button>
    </div>
    <div id="auth">
      <p>Identifiez-vous :</p>
      <input type="text" id="usernameInput" placeholder="Identifiant">
      <input type="password" id="userPasswordInput" placeholder="Mot de passe">
      <button onclick="checkCredentials()">Connexion</button>
    </div>
    <div id="bossDashboard" style="display: none;">
        <h3>üëë Tableau de Bord Boss</h3>
        <p><strong>Utilisateurs connect√©s :</strong></p>
        <ul id="connectedUsers"></ul>
    </div>

    <div id="adminPanel">
      <h2>Panel Administrateur</h2>
      <h3>Ajouter un nouvel utilisateur :</h3>
      <input type="text" id="newUsername" placeholder="Identifiant">
      <input type="password" id="newUserPassword" placeholder="Mot de passe">
      <select id="newUserRole">
        <option value="user">Utilisateur</option>
        <option value="admin">Administrateur</option>
      </select>
      <button onclick="addUser()">Ajouter</button>

      <h3>Supprimer un utilisateur :</h3>
      <input type="text" id="deleteUsername" placeholder="Identifiant">
      <button onclick="deleteUser()">Supprimer</button>

      <h3>Supprimer tous les messages (Admin uniquement) :</h3>
      <button onclick="deleteAllMessages()">Effacer le chat</button>
      
      <h3>Supprimer tous les fichiers partag√©s (Admin uniquement) :</h3>
      <button onclick="deleteAllFiles()">Effacer les fichiers</button>
    </div>

    <div id="chat">
      <h3>Chat du R√©seau</h3>
      <div id="messages"></div>
      <input type="text" id="chatInput" placeholder="√âcrire un message...">
      <button onclick="sendMessage()">Envoyer</button>
    </div>

    <div id="fileUpload">
      <h3>Partager un fichier</h3>
      <input type="file" id="fileInput">
      <button onclick="uploadFile()">T√©l√©charger</button>
      <div id="fileList"></div>
    </div>

    <button onclick="logout()">D√©connexion</button>
  </div>

  <script>
    const apiKey = "$2a$10$UKPxpQ92qE5GOG4OwBqJIOGKcuJehawwtWUWXCv4zI/WhDUuW.9A6";
    const jsonBinUrl = "https://api.jsonbin.io/v3/b/68286cc78960c979a59b4e80";

    function checkGeneralPassword() {
      const password = document.getElementById("passwordInput").value;
      if (password === "hacker123") {
        document.getElementById("auth").style.display = "block";
        document.getElementById("passwordInput").style.display = "none";
        // Masquer le bouton "Valider" (le premier bouton de la page)
        document.querySelector("button").style.display = "none";
      } else {
        alert("Mot de passe incorrect !");
      }
    }
   async function showUserProfile() {
    try {
        const response = await fetch(jsonBinUrl, { headers: { "X-Master-Key": apiKey } });
        const data = await response.json();
        let users = data.record.users || {};
        const username = sessionStorage.getItem("username");

        if (users[username]) {
            document.getElementById("userName").innerText = username;

            // D√©finir le statut selon le r√¥le
            const userStatus = users[username].status || 
                (users[username].role === "boss" ? "Boss" : 
                 users[username].role === "admin" ? "Admin" : "Utilisateur");

            document.getElementById("userStatus").innerText = userStatus;

            document.getElementById("userProfile").style.display = "block"; 
        }
    } catch (error) {
        console.error("Erreur lors du chargement du profil utilisateur :", error);
    }
    }
    async function showConnectedUsers() {
    try {
        const response = await fetch(jsonBinUrl, { headers: { "X-Master-Key": apiKey } });
        const data = await response.json();
        let users = data.record.users || {};
        const connectedUsersList = document.getElementById("connectedUsers");

        connectedUsersList.innerHTML = ""; // Nettoyer la liste

        Object.keys(users).forEach(username => {
            if (sessionStorage.getItem(username) === "online") { // V√©rifie la connexion
                let userRole = users[username].status || 
                               (users[username].role === "boss" ? "Boss" : 
                                users[username].role === "admin" ? "Admin" : "Utilisateur");
                                
                connectedUsersList.innerHTML += `<li>${username} (${userRole})</li>`;
            }
        });
    } catch (error) {
        console.error("Erreur lors du chargement des utilisateurs connect√©s :", error);
    }
    }


    async function checkCredentials() {
    try {
        const response = await fetch(jsonBinUrl, { headers: { "X-Master-Key": apiKey } });
        const data = await response.json();
        let users = data.record.users;
        const username = document.getElementById("usernameInput").value;
        const userPassword = document.getElementById("userPasswordInput").value;

        if (users[username] && users[username].password === userPassword) {
            sessionStorage.setItem("username", username);
            sessionStorage.setItem(username, "online"); // ‚úÖ Marquer l'utilisateur comme connect√©
            document.getElementById("auth").style.display = "none";
            document.getElementById("fileUpload").style.display = "block";
            document.getElementById("chat").style.display = "block";

            loadChatMessages();
            loadFiles();
            showUserProfile();

            // ‚úÖ V√©rification pour les Boss : Affichage du tableau de bord + liste des utilisateurs connect√©s
            if (users[username].role === "boss") {
                document.getElementById("bossDashboard").style.display = "block"; 
                showConnectedUsers(); // ‚úÖ Charger la liste des utilisateurs connect√©s
            }

            // ‚úÖ V√©rification pour les Admins : Acc√®s aux outils admin
            if (users[username].role === "admin" || users[username].role === "boss") {
                document.getElementById("adminPanel").style.display = "block"; 
            }

            // ‚úÖ V√©rification pour les Utilisateurs : Acc√®s aux fonctionnalit√©s de base uniquement
            if (users[username].role === "user") {
                document.getElementById("basicUserOptions").style.display = "block";
            }
        } else {
            alert("Identifiant ou mot de passe incorrect !");
        }
    } catch (error) {
        console.error("Erreur de connexion :", error);
    }
    }

    async function addUser() {
      const username = sessionStorage.getItem("username");
      const response = await fetch(jsonBinUrl, { headers: { "X-Master-Key": apiKey } });
      const data = await response.json();
      let users = data.record.users;

      if (!users[username] || users[username].role !== "admin") {
        alert("Seuls les administrateurs peuvent ajouter un utilisateur !");
        return;
      }

      const newUsername = document.getElementById("newUsername").value.trim();
      const newUserPassword = document.getElementById("newUserPassword").value.trim();
      const newUserRole = document.getElementById("newUserRole").value;

      if (!newUsername || !newUserPassword) {
        alert("Veuillez remplir tous les champs !");
        return;
      }

      users[newUsername] = { password: newUserPassword, role: newUserRole };
      await updateStorage(users, data.record.chat, data.record.files);
      alert("Utilisateur ajout√© avec succ√®s !");
    }

    async function deleteUser() {
      const username = sessionStorage.getItem("username");
      const response = await fetch(jsonBinUrl, { headers: { "X-Master-Key": apiKey } });
      const data = await response.json();
      let users = data.record.users;

      if (!users[username] || users[username].role !== "admin") {
        alert("Seuls les administrateurs peuvent supprimer un utilisateur !");
        return;
      }

      const usernameToDelete = document.getElementById("deleteUsername").value.trim();
      delete users[usernameToDelete];
      await updateStorage(users, data.record.chat, data.record.files);
      alert("Utilisateur supprim√© !");
    }

    async function deleteAllMessages() {
      const username = sessionStorage.getItem("username");
      const response = await fetch(jsonBinUrl, { headers: { "X-Master-Key": apiKey } });
      const data = await response.json();
      let users = data.record.users;

      if (!users[username] || users[username].role !== "admin") {
        alert("Seuls les administrateurs peuvent effacer le chat !");
        return;
      }
      // On supprime seulement les messages, on conserve les utilisateurs et fichiers.
      await updateStorage(users, [], data.record.files);
      document.getElementById("messages").innerHTML = "";
      alert("Messages supprim√©s !");
    }

    async function deleteAllFiles() {
      const username = sessionStorage.getItem("username");
      const response = await fetch(jsonBinUrl, { headers: { "X-Master-Key": apiKey } });
      const data = await response.json();
      let users = data.record.users;

      if (!users[username] || users[username].role !== "admin") {
        alert("Seuls les administrateurs peuvent effacer les fichiers partag√©s !");
        return;
      }
      // On supprime seulement les fichiers, on conserve les utilisateurs et messages.
      await updateStorage(users, data.record.chat, []);
      document.getElementById("fileList").innerHTML = "";
      alert("Fichiers partag√©s supprim√©s !");
    }

    async function uploadFile() {
      const fileInput = document.getElementById("fileInput").files[0];
      if (!fileInput) {
        alert("S√©lectionnez un fichier !");
        return;
      }
      const response = await fetch(jsonBinUrl, { headers: { "X-Master-Key": apiKey } });
      const data = await response.json();
      let files = data.record.files || [];
      files.push({ name: fileInput.name, url: URL.createObjectURL(fileInput) });
      await updateStorage(data.record.users, data.record.chat, files);
      loadFiles();
    }

    async function loadFiles() {
      const response = await fetch(jsonBinUrl, { headers: { "X-Master-Key": apiKey } });
      const data = await response.json();
      let files = data.record.files || [];
      document.getElementById("fileList").innerHTML = files.map(file => `<p><a href="${file.url}" download>${file.name}</a></p>`).join("");
    }

    async function loadChatMessages() {
    try {
        const response = await fetch(jsonBinUrl, { headers: { "X-Master-Key": apiKey } });
        const data = await response.json();
        let chatMessages = data.record.chat || [];
        let users = data.record.users || {};

        const chatDiv = document.getElementById("messages");
        chatDiv.innerHTML = "";

        chatMessages.forEach(msg => {
            let userRole = users[msg.username]?.status || 
                           (users[msg.username]?.role === "boss" ? "Boss" : 
                            users[msg.username]?.role === "admin" ? "Admin" : "Utilisateur");

            chatDiv.innerHTML += `<p class="message"><strong>${msg.username} (${userRole}):</strong> ${msg.message} 
            <span style="font-size: 10px;">(${msg.timestamp})</span></p>`;
        });
    } catch (error) {
        console.error("Erreur lors du chargement des messages :", error);
    }
    }

    async function updateStorage(users, chatMessages, files) {
      try {
        await fetch(jsonBinUrl, {
          method: "PUT",
          headers: { "X-Master-Key": apiKey, "Content-Type": "application/json" },
          body: JSON.stringify({ users, chat: chatMessages, files })
        });
      } catch (error) {
        console.error("Erreur lors de la mise √† jour du stockage :", error);
      }
    }
    async function updateChatStorage(users, chatMessages, files) {
    try {
        await fetch(jsonBinUrl, {
            method: "PUT",
            headers: { 
                "Content-Type": "application/json",
                "X-Master-Key": apiKey 
            },
            body: JSON.stringify({ users, chat: chatMessages, files })
        });
    } catch (error) {
        console.error("Erreur de mise √† jour du chat :", error);
        alert("Impossible de mettre √† jour les messages !");
    }
    }

    async function sendMessage() {
    try {
        const message = document.getElementById("chatInput").value.trim();
        const username = sessionStorage.getItem("username");
        const timestamp = new Date().toLocaleString();

        if (!message) {
            alert("Veuillez entrer un message !");
            return;
        }

        const response = await fetch(jsonBinUrl, { headers: { "X-Master-Key": apiKey } });
        const data = await response.json();
        let chatMessages = data.record.chat || [];
        let users = data.record.users || {};

        // R√©cup√©rer le r√¥le de l'utilisateur
        let userRole = users[username]?.status || 
                       (users[username]?.role === "admin" ? "Admin" : "Utilisateur");

        chatMessages.push({ username, message, timestamp, role: userRole });

        await updateChatStorage(users, chatMessages, data.record.adminChat, data.record.files);
        loadChatMessages();

        document.getElementById("chatInput").value = ""; 
    } catch (error) {
        console.error("Erreur lors de l'envoi du message :", error);
        alert("Une erreur est survenue, veuillez r√©essayer !");
    }
    }

    function logout() {
      sessionStorage.removeItem("username");
      window.location.href = "index.html";
    }
    // Actualisation automatique du chat toutes les 5 secondes
setInterval(loadChatMessages, 5000);
setInterval(showConnectedUsers, 5000);
  </script>
</body>
</html>